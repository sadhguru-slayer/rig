import { NextResponse } from "next/server";
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export async function POST(request) {
  try {
    const formData = await request.formData();
    const contentJSON = JSON.parse(formData.get("content"));
    const tags = JSON.parse(formData.get("tags") || "[]");
    const seo = JSON.parse(formData.get("seo") || "{}");

    // Build files map from FormData
    const filesMap = {};
    for (const value of formData.getAll("images")) {
      filesMap[value.name] = value;
    }

    
    // Save blog
    const newBlog = await prisma.blog.create({
      data: {
        title: formData.get("title"),
        slug: formData.get("slug"),
        excerpt: formData.get("excerpt"),
        coverImage: formData.get("coverImage"),
        author: formData.get("author"),
        published: formData.get("published") === "true",
        content: contentJSON,
        tags,
        readTime: parseInt(formData.get("readTime") || "0"),
        views: 0,
        seo: seo
          ? { create: { ...seo } }
          : undefined,
      },
      include: { seo: true },
    });

    return NextResponse.json({ success: true, data: newBlog });
  } catch (error) {
    console.error("Blog POST error:", error);
    return NextResponse.json({ success: false, error: error.message }, { status: 500 });
  }
}


export async function GET() {
  try {
    const blogs = await prisma.blog.findMany({
      include: { seo: true },
      orderBy: { createdAt: "desc" },
    });
    return NextResponse.json({ success: true, data: blogs });
  } catch (error) {
    console.error("ðŸš¨ Blog GET error:", error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
